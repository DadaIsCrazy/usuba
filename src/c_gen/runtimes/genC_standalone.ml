open Usuba_AST
open Basic_utils
open Utils
       

let bits_per_reg (prog:prog) (conf:config) : int =
  match conf.archi with
  | Std -> (let main = last prog.nodes in
            let typ  = (List.hd main.p_in).vtyp in
            match get_type_dir typ with
            | Vslice -> (match get_type_m (List.hd main.p_in).vtyp with
                         | Mint x -> x
                         | _ -> assert false)
            | _ -> conf.bits_per_reg)
  | _   -> default_bits_per_reg conf.archi
       
let gen_runtime (orig:prog) (prog:prog) (conf:config) (filename:string) : string =

  let def_to_c = if conf.fdti then Nodes_to_c_fdti.def_to_c else Nodes_to_c.def_to_c in
  let entry = List.(def_to_c (nth prog.nodes (length prog.nodes -1))
                             conf.arr_entry conf) in

    (* if conf.fdti then *)
    (*             List.(Nodes_to_c_fdti.def_to_c (nth prog.nodes (length prog.nodes -1)) *)
    (*                     conf.arr_entry conf) *)
    (*           else *)
    (*             List.(Nodes_to_c.def_to_c (nth prog.nodes (length prog.nodes -1)) *)
  (*                     conf.arr_entry conf) in *)
  
  let prog_c =  map_no_end (fun x -> def_to_c x false conf) prog.nodes in

               (* if conf.fdti <> "" then *)
               (*   map_no_end (fun x -> Nodes_to_c_fdti.def_to_c x false conf) prog.nodes *)
               (* else *)
               (*   map_no_end (fun x -> Nodes_to_c.def_to_c x false conf) prog.nodes in *)


Printf.sprintf 
"/* This code was generated by Usuba.
   See https://github.com/DadaIsCrazy/usuba.
   From the file \"%s\" (included below). */

#include <stdint.h>

/* Do NOT change the order of those define/include */
%s
#ifndef BITS_PER_REG
#define BITS_PER_REG %d
#endif
/* including the architecture specific .h */
#include \"%s\"

/* auxiliary functions */
%s

/* main function */
%s


/* **************************************************************** */
/*                            Usuba source                          */
/*                                                                  */
/*

%s

*/
 "
  filename
  (if conf.runtime then "#define RUNTIME" else "#define NO_RUNTIME")
  (bits_per_reg prog conf)
  (if conf.fdti then Nodes_to_c_fdti.c_header conf.archi else Nodes_to_c.c_header conf.archi)
  (join "\n\n" prog_c)
  entry
  (Usuba_print.prog_to_str orig)
